# go-opens
变长六十四进制字符编码方案原则
1.如果可以接受ID编码中允许存在字母和少量符号的话，用六十四进制字符能达到更短ID长度、容纳更多信息的可见字符编码。
2.既然不受64位整型位宽限制，那么可以考虑变长的ID配置方案

暂定义六十四进制字符集合如下
0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ,.
（共64个可见字符）

ID编码规则
区号	区名	备注
第一区	分区目录	2个六十四进制字符	共12个二进制位
第一段3个二进制位表示保留区六十四进制字符个数，最大值7
第二段3个二进制位表示服务器编号区六十四进制字符个数，最大值7
第三段3个二进制位表示秒戳区六十四进制字符个数，最大值7
第四段3个二进制位表示序号区六十四进制字符个数，最大值7
第二区	保留区	a个六十四进制字符
当a==1时，有6个二进制位可用；当a==2时，有12个二进制位可用
第三区	服务器编号区	b个六十四进制字符
当b==1时，可表示64台发起器服务器；当b==2时，可表示4096台发起器服务器；当b==3时，可表示262144台发起器服务器
第四区	秒戳区	c个六十四进制字符
当c==5时，可表示34年的秒戳；当c==6时，可表示2179年的秒戳。可定义成从2017-01-01 00:00:00开始^_^
第五区	序号区	d个六十四进制字符
当d==2时，序号区间[1,4096]；当d==3时，序号区间[1,26万]；当d==4时，序号区间[1,1677万]；当d==5时，序号区间[1,10亿]
		共2+a+b+c+d个六十四进制字符

推荐可配置的一种ID编码方案
区号	区名	备注
第一区	分区目录	2个六十四进制字符
二进制表达为"001 010 110 100"，六十四进制表达为"aQ"(692/64=10余52)
第二区	保留区	1个六十四进制字符
有6个二进制位可用
第三区	服务器编号区	2个六十四进制字符
可表示4096台发起器服务器
第四区	秒戳区	6个六十四进制字符
可表示2179年的秒戳
第五区	序号区	5个六十四进制字符
序号区间[1,10亿]
		共16个六十四进制字符

服务端以HTTP方式对外提供发号服务，一些关键设计
1.服务端配置每个URI对应一种ID编码方案，可同时对不同业务提供不同编码方案的ID发号。关系信息以URI为主键组织成树结构以提高查询效率。
2.服务端进程结构为“父进程-子进程组”，父进程用mmap创建内存映射文件放当前序号值，供子进程组查询和自增一。内存映射文件的好处是当前序号自动异步持久化到文件中，当子进程崩溃时能自我恢复。
3.由于存在并发，可使用gcc内置函数__sync_bool_compare_and_swap自旋实现乐观锁。
4.不仅提供单笔接口，还提供批量接口。
5.利用优雅重启设计，保证服务端重启或主程序升级时不中断对外服务。

2定长64位整型方案
定长64位整型方案原则
1.这是业界使用最多的位宽方案，主要便于直接通过移位产生和直接单整型值输出。
2.因为区布局在设计时就固定下来，故不需要分区目录。
3.基于发号器服务器集群原则，需要有服务器编号区，每个服务器产生的ID都有自己的区间，也便于事后查询哪台服务器产生的ID。
4.基于时间可反解原则，需要有秒戳区，但无需毫秒戳区，因为一般交易时间信息只要秒戳就可以了，毫秒戳的10个位跳跃稀疏太大，还不如留给序号区。
5.基于ID中容纳其它信息如版本号、业务类型等，需要有保留区。

ID编码规则
区号	区名	备注
第一区	服务器编号区	8位
可表示256台发起器服务器，刚好一个子网段的机器数量
第二区	秒戳区	30位
可表示34年的秒戳。可定义成从2017-01-01 00:00:00开始^_^
第三区	保留区	4位
共16个二进制位，可放版本号、业务类型等信息
第四区	序号区	22位
序号区间[1,419万]
		共64位，刚好是一个uint64_t类型整型变量的位宽，便于直接输出成一个数字
